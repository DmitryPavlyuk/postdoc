---
title: "EWGT2019"
author: "Dmitry Pavlyuk"
date: "February 6, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

This markdown document reproduces the research "Ensemble learning of the spatiotemporal structure of urban traffic
flows", submitted to EURO Working Group on Transportation Meeting, EWGT 2019


```{r child='sampling.Rmd'}
```


Load necessary libraries
----------------
```{r libs}
memory.limit(size=1024*128)
library(needs)
needs(knitr)
needs(tidyverse)
needs(reshape2)
needs(ggplot2)
needs(geosphere)
needs(igraph)
needs(Metrics)
needs(imputeTS)
needs(e1071)
needs(MTS)
needs(forecast)
needs(doParallel)
needs(glasso)
needs(scales)

source(file.path("R","prepare_data_functions.R"))
source(file.path("R","cv_functions.R"))
source(file.path("R","cv_utils.R"))
source(file.path("R","models_util.R"))
source(file.path("R","models_baseline.R"))
source(file.path("R","models_spvar.R"))


# Define files for intermediate results
models.estimated.file <- "EWGT2019.models.estimated.rds"
results.file <- "EWGT2019.results.rds"
fs.file <- "EWGT2019.fs.rds"
summary.file <- "EWGT2019.summary.rds"
```


```{r models}
RunModels <- function(data, series, ta, forecastingSteps, forecastEvery,
                      validationSize, validationEnd, 
                      lagMatrix, cvgrid, 
                      models.estimated.file, results.file,save.links.file){
  start.time <- Sys.time()
  
  results<-tibble()
  models.estimated <- c()
  if (file.exists(models.estimated.file)) models.estimated <- readRDS(models.estimated.file)
  if (file.exists(results.file)) results <- readRDS(results.file)
  
  for (r in 1:nrow(cvgrid)){
    cv <- cvgrid[r,]
    print(paste("Tuned parameter's set",r,"of",nrow(cvgrid)))
    print(cv)
    validationStart <- validationEnd - validationSize
    trainingSize <- cv$trainingMinutes/ta
    dat.restricted<-data[(validationStart-trainingSize+1):validationEnd,]
    base_params<-list(data=dat.restricted, seriesNames=series, 
                      forecastingSteps=forecastingSteps, forecastEvery=forecastEvery)
    params<-c(base_params,list(trainingWindowSize=trainingSize))

    #HA
    modelid <- paste(xModel.zero$name,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=xModel.zero)),
               envir=environment())
      results<-bind_rows(results,res)
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    #Simple mean
    modelid <- paste(xModel.mean$name,cv$trainingMinutes,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=xModel.mean)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    
    #MA
    modelid <- paste(xModel.ma$name,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=xModel.ma)),
               envir=environment())
      results<-bind_rows(results,res)
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
  
    #Naive
    modelid <- paste(xModel.naive$name,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=xModel.naive)),
               envir=environment())
      results<-bind_rows(results,res)
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    #Auto arima
    modelid <- paste(xModel.autoarima$name,cv$trainingMinutes,
                     cv$include.mean,cv$stationary,cv$allowdrift,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=xModel.autoarima,
                             allowmean=cv$include.mean,
                             stationary=cv$stationary,
                             allowdrift=cv$allowdrift)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,include.mean=cv$include.mean,
                             stationary=cv$stationary,
                             allowdrift=cv$allowdrift))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    # Glasso
    modelid <- paste(suf(xModel.star,"glasso")$name,cv$trainingMinutes,
                     cv$arLags,cv$glassoRho,cv$include.mean,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=suf(xModel.star,"glasso"),matrixMode="glasso",
                             control=list(glassoRho=cv$glassoRho),
                             arLags=cv$arLags,include.mean=cv$include.mean,save_links_file=save.links.file)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,arLags=cv$arLags,
                         include.mean=cv$include.mean,glassoRho=cv$glassoRho))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    # Travel time
    modelid <- paste(suf(xModel.star,"travelTime")$name,cv$trainingMinutes,
                     cv$arLags,cv$include.mean,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=suf(xModel.star,"travelTime"),matrixMode="travelTime",
                             control=list(lagMatrix=lagMatrix),
                             arLags=cv$arLags,include.mean=cv$include.mean,save_links_file=save.links.file)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,arLags=cv$arLags,
                         include.mean=cv$include.mean))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    # CCF
    modelid <- paste(suf(xModel.star,"ccf")$name,cv$trainingMinutes,
                     cv$arLags,cv$ccfThreshold,cv$include.mean,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=suf(xModel.star,"ccf"),matrixMode="CCF",
                             control=list(ccfThreshold=cv$ccfThreshold),
                             arLags=cv$arLags,include.mean=cv$include.mean,save_links_file=save.links.file)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,arLags=cv$arLags,
                         include.mean=cv$include.mean,ccfThreshold=cv$ccfThreshold))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    # Ensemble
    modelid <- paste(suf(xModel.star,"ensemble")$name,cv$trainingMinutes,
                     cv$arLags,cv$glassoRho,cv$ccfThreshold,
                     cv$include.mean,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=suf(xModel.star,"ensemble"),matrixMode=c("glasso","CCF", "travelTime"),
                             control=list(glassoRho=cv$glassoRho,lagMatrix=lagMatrix,ccfThreshold=cv$ccfThreshold),
                             arLags=cv$arLags,include.mean=cv$include.mean,save_links_file=save.links.file)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,arLags=cv$arLags,
                         include.mean=cv$include.mean,glassoRho=cv$glassoRho,ccfThreshold=cv$ccfThreshold))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    # Complete
    modelid <- paste(suf(xModel.star,"complete")$name,cv$trainingMinutes,
                     cv$arLags, cv$include.mean,collapse = '')
    if (!(modelid %in% models.estimated)){
      print(paste("Estimating model",modelid))
      res<-do.call(rollingWindow,
               c(params,list(xModel=suf(xModel.star,"complete"),matrixMode="complete",
                             control=list(),
                             arLags=cv$arLags,include.mean=cv$include.mean)),
               envir=environment())
      results<-bind_rows(results,res%>%mutate(trainingMinutes=cv$trainingMinutes,arLags=cv$arLags,
                         include.mean=cv$include.mean))
      models.estimated<-c(models.estimated,modelid)
      saveRDS(results, results.file)
      saveRDS(models.estimated, models.estimated.file)
    }else{
      print(paste("Model",modelid,"already estimated; skipped"))
    }
    
    print(Sys.time() - start.time)
  }
}
```

```{r experiments}

# Read sample data
series <- colnames(mysample$data)[-1]
print(paste("Number of series", length(series)))

# Prepare a matrix of maximal lags (for travel time regularisation)
lagMatrix <- round(mysample$shortest.distances / ta)
lagMatrix[is.infinite(lagMatrix)]<-0
rownames(lagMatrix)<-paste0(rownames(lagMatrix),".volume")
colnames(lagMatrix)<-paste0(colnames(lagMatrix),".volume")
lagMatrix<-lagMatrix[as.vector(series),as.vector(series)]


# Define validation sample (10 weeks - 1 day at the beginning)
validationSize <- nrow(mysample$data)-1*24*60/ta
validationEnd <- nrow(mysample$data)
forecastEvery<-60*6
forecastingSteps<-3

# Do not save features - just search for optimal model specifications
save.links.file <- NULL




# Preliminary search results:
# arLag=9 is ineffective (because the area is limited with 6 minutes, decided to limit arLag search by 1,3,6
# trainingMinutes=7*24*60 is ineffective,decided to use 720-minutes lookback (necessary for 6-lag models) 
# Sample size - 480 wins against 720 for all arLag=3, except complete VAR
# glassoRho=0.01 is ineffective, glassoRho=0.5 is ineffective
# ccfThreshold<0.7 ineffective

# Define a grid for tuning parameters
ccfThresholds <- c(0.1, 0.3, 0.5)
glassoRhos <- c(0.05, 0.1, 0.3)
means <- c(F)
ar_orders <- c(1, 3)
stationary <- c(F)
allowdrift <- c(F)
trainingMinutes <- c(480)

cvgrid <- expand.grid(trainingMinutes = trainingMinutes,
                        glassoRho = glassoRhos, ccfThreshold=ccfThresholds, 
                        include.mean = means, arLags = ar_orders,
                        stationary = stationary,
                        allowdrift = allowdrift)

# Run all models
RunModels(mysample$data, series, ta, forecastingSteps, forecastEvery,
                      validationSize, validationEnd, 
                      lagMatrix, cvgrid, 
                      models.estimated.file, results.file,save.links.file)
# Choose models with optimal sets of tuned parameters for arLargs=3
params <- c('trainingMinutes','allowdrift','stationary','arLags','glassoRho','ccfThreshold','include.mean')

# Read estimation results
results <- readRDS(results.file)
models.estimated <- readRDS(models.estimated.file)
s<-cvSummary(results, mae, cumulative=T, params=params)%>%
    mutate(modelid=paste(model,trainingMinutes, arLags,glassoRho, ccfThreshold,include.mean,stationary,allowdrift))%>%
    mutate(modelid=gsub(" NA","",modelid))
saveRDS(s, summary.file)



winners3 <- s%>%
    filter(forecast_horizon==3,arLags==3)%>%
    group_by(model)%>%filter(MAE==min(MAE))%>%ungroup

# Re-estimate best model specification, saving features on every step
  reestimate.ids <- winners3%>%
    filter(model %in% c("STAR ccf", "STAR glasso", "STAR ensemble", "STAR travelTime"))%>%select(modelid)%>%pull

  save.links.file <- file.path("fs", fs.file)
  tmp.models.estimated.file <- "tmp.EWGT2019.models.estimated.rds"
  tmp.results.file <- "tmp.EWGT2019.results.rds"
  if (file.exists(save.links.file)) file.remove(save.links.file)
  saveRDS(models.estimated[! models.estimated %in% reestimate.ids], tmp.models.estimated.file)
  if (file.exists(tmp.results.file)) file.remove(tmp.results.file)
  
  
  RunModels(mysample$data, series, ta, forecastingSteps, forecastEvery,
                      validationSize, validationEnd, 
                      lagMatrix, cvgrid, 
                      tmp.models.estimated.file, tmp.results.file,save.links.file)
  
  
  # Combine features from individual models
  fs.tib <- tibble()
  ls <- list.files(path="fs")
  cou<-0
  for (i in ls){
    rf <- readRDS(file.path("fs", i))
    pars<- rf%>%first%>%select(training_minutes,max_lag)
    #if (pars$max_lag==3){
      cou<-cou+1
      fs.tib<-bind_rows(fs.tib,rf)
       print(cou)
      # if (cou %% 6 == 0){
      #   saveRDS(fs.tib, file.path("fs4",paste0("fs.rds", cou)))
      #   fs.tib <- tibble()
      # }
    #}
  }
  if (nrow(fs.tib)>0) saveRDS(fs.tib, fs.file)
  
  fs.tib<-fs.tib%>%mutate(modelid=paste(ifelse(fs=="CCF","ccf",fs),training_minutes,max_lag,glasso_rho, ccf_threshold,include_mean))%>%
    mutate(last_date = as.POSIXct(last_date, "%Y-%m-%d %H:%M:%S",tz="GMT"))%>%
    mutate(modelid=gsub(" NA","",modelid))
  saveRDS(fs.tib, fs.file)
  
```

```{r results}

fs.tib <- readRDS(fs.file)
results <- readRDS(results.file)

params <- c('trainingMinutes','allowdrift','stationary','arLags','glassoRho','ccfThreshold','include.mean')
if (file.exists(summary.file)){
  s <- readRDS(summary.file)
} else {
  s <- cvSummary(results, mae, cumulative=T, params=params)%>%
    mutate(modelid=paste(model,trainingMinutes, arLags,glassoRho, ccfThreshold,include.mean,stationary,allowdrift))%>%
    mutate(modelid=gsub(" NA","",modelid))
  saveRDS(s, summary.file)
}


winners <- s%>%
    filter(forecast_horizon==3)%>%
    group_by(model)%>%filter(MAE==min(MAE))%>%ungroup

winners <- s%>%
    filter(forecast_horizon==3, arLags == 3)%>%
    group_by(model)%>%filter(MAE==min(MAE))%>%ungroup

star.models <- winners%>%
    filter(model %in% c("STAR ccf", "STAR glasso", "STAR ensemble", "STAR travelTime"))%>%
  select(modelid)%>%pull
#star.models <- c(star.models, "STAR glasso 720 3 0.3 FALSE")
#cvSummary(results, mae, params=params, cumulative = T)%>%filter(forecast_horizon==3)%>%arrange(MAE)%>%print(n=100)

  fs.tib%>%filter(value>0)%>%filter(modelid %in% gsub("STAR ","",star.models))%>%
    group_by(modelid,last_date)%>%
    summarise(n=n())%>%arrange(modelid, last_date)%>%
    ggplot(aes(x = last_date, y = n, col=modelid, group=modelid)) + geom_line()
  
  fmt<-"%H:%M:%S"
 fs.tib%>%filter(value>0)%>%filter(modelid %in% gsub("STAR ","",star.models))%>%
    group_by(modelid,last_date)%>%
    summarise(n=n())%>%
    mutate(last_date_d = format(last_date, format=fmt,tz="GMT"))%>%
    group_by(modelid,last_date_d)%>%
    summarise(mn=mean(n), ld=last(last_date))%>%
    ggplot(aes(x = ld, y = mn, col=modelid, group=modelid)) + geom_line()+scale_x_datetime(labels = date_format(fmt), date_breaks = "3 hours")


 g <- c('model',params) 
 tmp<-results%>%
      group_by(model_hash,detector)%>%
      arrange(model_hash,detector,forecast_horizon)%>%
      mutate(cumactual=cumsum(actual),cumforecasted=cumsum(forecasted))
 
 saveRDS(tmp, "EWGT2019.results-cum.rds")
 
 tmp1<-tmp%>%
  group_by(.dots=c(g,'forecast_horizon','detector', 'datetime'))%>%
  summarise(v=mae(cumactual,cumforecasted))%>%mutate(modelid=gsub(" NA","",paste(model,trainingMinutes, arLags,glassoRho, ccfThreshold,include.mean,stationary,allowdrift)))
 
  gtmp<-tmp1%>%filter(forecast_horizon==3)%>%group_by(modelid,datetime)%>%
    summarise(mn=mean(v))
  
  needs(stringr)
  m<- winners%>%select(modelid)%>%pull
  m<-winners%>%select(modelid)%>%filter(str_detect(modelid,"^STAR") )%>%pull
  m <- c("STAR ccf 480 3 0.7 FALSE","STAR glasso 480 1 0.3 FALSE","STAR ensemble 480 3 0.1 0.7 FALSE","STAR travelTime 480 3 FALSE")
  m <- c("STAR ensemble 480 3 0.1 0.7 FALSE")
  
  gtmp%>%filter(modelid %in% m)%>%
    ggplot(aes(x = datetime, y = mn, col=modelid, group=modelid)) + geom_line()+scale_x_datetime(labels = date_format(fmt), date_breaks = "1 day")
  
  # gtmp%>%filter(modelid %in% m)%>%filter(mn>50)
  # tmp1%>%filter(forecast_horizon==3,modelid=="STAR ensemble 480 3 0.1 0.7 FALSE",
  #               last_date=="2017-07-31 07:00:00", v>100)%>%select(detector,last_date,v)
  # # Problem rnd_86469.volume 2017-07-31 04:00:00 2149
  # tm<-tmp%>%filter(detector=="rnd_86469.volume", forecast_horizon==3)
  # tm1<-tm%>%filter(datetime==as.POSIXct("2017-07-31 04:03:00", format="%Y-%m-%d %H:%M:%S",tz="GMT"))
  # # Problems max rnd_95345.volume  rnd_87459.volume rnd_85591.volume rnd_172.volume
  # mysample$data%>%select(datetime, rnd_95345.volume)%>%ggplot(aes(x = datetime, y = rnd_95345.volume)) + geom_line()+scale_x_datetime(labels = date_format(fmt), date_breaks ="3 hours")
                                                                                                
                                                                                                
  gtmp%>%filter(modelid %in% m)%>%mutate(last_date_d = format(datetime, format=fmt,tz="GMT"))%>%
    group_by(modelid,last_date_d)%>%
    summarise(meann=median(mn), ld=last(datetime))%>%
    ggplot(aes(x = ld, y = meann, col=modelid, group=modelid)) + geom_line()+scale_x_datetime(labels = date_format(fmt), date_breaks = "3 hours")
  
  
  
  gtmp%>%filter(modelid %in% m)%>%group_by(modelid)%>%summarise(mean=mean(mn), sd=sd(mn))
      
```