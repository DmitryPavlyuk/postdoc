---
title: "Ensemble feature selection"
author: "Dmitry Pavlyuk"
date: "March 24, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This markdown document reproduces the research "Robust learning of urban traffic flows' spatiotemporal structure" (to be submitted)


```{r child='sampling.Rmd'}
```


Load necessary libraries
----------------
```{r libs}
library(needs)
needs(knitr)
needs(tidyverse)
needs(reshape2)
needs(ggplot2)
needs(geosphere)
needs(igraph)
needs(Metrics)
needs(imputeTS)
needs(e1071)
needs(MTS)
needs(forecast)
needs(doParallel)
needs(glasso)
needs(scales)
needs(stringr)
needs(e1071 )
needs(randomForest )
needs(Boruta)
needs(ggplot2)
needs(tibbletime)
needs(tidyverse)
needs(svMisc)
needs(rlist)
needs(plot.matrix)
needs(fsMTS)

source(file.path("R","prepare_data_functions.R"))
source(file.path("R","cv_functions.R"))
source(file.path("R","cv_utils.R"))
source(file.path("R","models_util.R"))
source(file.path("R","models_baseline.R"))
source(file.path("R","models_spvar.R"))
source(file.path("R","models_spatial.R"))


# Define files for intermediate results
dir<-"TRC2020"
models.estimated.file <- file.path(dir,"models.rds")
results.file <- file.path(dir,"results.rds")
complete.rds <- file.path("data","prepared","ALL5-original.rds")
sample.rds <- file.path(dir,"data64.rds")
ta<-5
```

```{r localized_vs_global}
folder <- "C:/tmp/fs/64"
fname<-"MI"
maxsize<-4032
localized <- readRDS(file.path(folder,paste0(fname,"loc/",maxsize,"/3/2017-08-13_000000.rds")))
global <- readRDS(file.path(folder,paste0(fname,"/",maxsize,"/3/2017-08-13_000000.rds")))
cor(as.vector(localized), as.vector(global))
df.compare <- data.frame(threshold=seq(0,1,by=0.05), similarity = NA)
for (i in 1:nrow(df.compare))
  df.compare[i,"similarity"]<-fsMTS::fsSimilarity(localized, global,cutoff=T, threshold = df.compare[i,"threshold"], method = "Kuncheva")
df.compare
image(localized)
localised.folder <- file.path(folder,paste0(fname,"locg/36/3"))
global.folder <- file.path(folder,paste0(fname,"g/36/3"))
res<-NULL
for (f in list.files(localised.folder )){
  loc <- readRDS(file.path(localised.folder,f))
  glob <- readRDS(file.path(global.folder,f))
  for (thres in seq(0,1,by=0.05)){
    res<-bind_rows(res,list(filename=f,threshold=thres, 
                       similarity=fsMTS::fsSimilarity(loc, glob,cutoff=T, threshold =thres, method = "Kuncheva")))
  }
}
res <-as_tibble(res)
res<-res%>%mutate(sec=as.numeric(gsub(".rds","",filename)), time=(sec/3600))
res.gr<-res%>%arrange(time)%>%group_by(time)%>%summarise(minsimilarity=min(similarity),maxsimilarity=max(similarity))
res.gr%>%ggplot(aes(x = time, y=minsimilarity))+geom_line()

localised.folder <- file.path(folder,paste0(fname,"loc/36/3"))
global.folder <- file.path(folder,paste0(fname,"/36/3"))
res2<-NULL
for (f in list.files(localised.folder )){
  loc <- readRDS(file.path(localised.folder,f))
  glob <- readRDS(file.path(global.folder,f))
  for (thres in seq(0,1,by=0.05)){
    res2<-bind_rows(res2,list(filename=f,threshold=thres, 
                       similarity=fsMTS::fsSimilarity(loc, glob,cutoff=T, threshold =thres, method = "Kuncheva")))
  }
  print(f)
}
res2 <-as_tibble(res2)
fmt <- "%Y-%m-%d_%H%M%S"
res2<-res2%>%filter(threshold>0.0)%>%mutate(time=as.POSIXct(gsub(".rds","",filename),format=fmt, tz="GMT"))%>%mutate(dow_time=format(time,"%w %H:%M", tz="GMT"))
saveRDS(res2, file.path(dir,paste0(fname,"_localised_vs_global.rds")))

res2.gr<-res2%>%filter(threshold==0.1)%>%arrange(dow_time)%>%group_by(dow_time)%>%summarise(time=min(time),minsimilarity=min(similarity),maxsimilarity=max(similarity))
res2.gr%>%ggplot(aes(x = time, y=minsimilarity))+geom_line()
```

```{r fs_stability}


oneStepSimilarity <- function(folder, date.from,date.to, threshold, method){
  dates <- seq(from=date.from, to=date.to, by="5 min")
  res <- NULL
  fs.prev<-NULL
  for(row in 1:length(dates)){
    name<-format(dates[row],fmt)
    filename <- paste0(name,".rds")
    if (file.exists(file.path(folder, filename))){
      fs <- readRDS(file.path(folder, filename))
      if (!is.null(fs.prev)){
        res <- bind_rows(res,
                         list(datetime=dates[row], 
                         similarity=fsMTS::fsSimilarity(fs.prev, fs,cutoff=T, 
                                                        threshold = threshold, method=method),
                         threshold = threshold,
                         method=method,
                         key=folder))
      }
      fs.prev <- fs
    }else{
      fs.prev <- NULL
    }
  }
  return(res)
}

folder<-file.path("C:/tmp/fs/64","MIloc","36/3/0.3")
fmt <- "%Y-%m-%d_%H%M%S"
date.from <- as.POSIXct("2017-07-31_000000",format=fmt)
date.to <- as.POSIXct("2017-10-07_000000",format=fmt)

sim.tibble<-NULL
for (th in seq(0,1,by=0.1)){
  for (method in c("Kuncheva")){
    print(paste("Estimating: threshold=",th,", method=", method))
    r<-oneStepSimilarity(folder, date.from,date.to, threshold=th, method=method)
    sim.tibble<- bind_rows(sim.tibble, r)
  }
}

res<-sim.tibble%>%mutate(dow_time=format(datetime,"%w %H:%M"))
saveRDS(res, file.path(dir,"GLASSOloc_oneStepSimilarity.rds"))

res%>%filter(method=="Kuncheva", threshold>0)%>%mutate(key=paste(key, threshold))%>%group_by(key,dow_time)%>%summarise(mean.similarity=mean(similarity))%>%ggplot(aes(x = dow_time, y=mean.similarity, group=key, col=key))+geom_line()

stat<-res%>%filter(threshold>0)%>%group_by(method,key,threshold)%>%summarise(mean.similarity=mean(similarity))
stat%>%ungroup%>%mutate(key=paste(key, method))%>%group_by(key)%>%ggplot(aes(x = threshold, y=mean.similarity, group=key, col=key))+geom_line()
```
```{r}

fs <- readRDS(file.path(folder,"2017-07-31_080000.rds"))
res<-as_tibble(cutoff(fs,0.1),rownames = "lnode")%>%gather(key="node", value="value",-one_of("lnode"))%>%filter(value==1)%>%
  mutate(lag=as.numeric(substr(lnode,regexpr(".l",lnode)+2,length(lnode))),
         related_node=substr(lnode,1,regexpr(".l",lnode)-1))%>%select(node,related_node,lag)
res%>%group_by(node,lag)%>%summarise(n=n())%>%arrange(node,desc(n))%>%print(n=100)

res%>%filter(node=="rnd_95775")%>%print(n=30)
related<-res%>%filter(node=="rnd_95775")%>%select(related_node)%>%pull
write.csv(mysample$config.nodes%>%filter(node_name %in% related)%>%inner_join(res%>%filter(node=="rnd_95775"), by=c("node_name"="related_node")),file.path(dir,"nodes-lag1.csv"),  row.names = F)

```

```{r}
dates <- seq(from=date.from, to=date.to, by="5 min")

mlist<-list()
for(row in 1:length(dates)){
  name<-format(dates[row],fmt)
  filename <- paste0(name,".rds")
  if (file.exists(file.path(folder, filename))){
    fs <- readRDS(file.path(folder, filename))
    mlist[[name]]<-fs
  }
}
msim<-fsSimilarityMatrix(mlist,threshold=0.2,method="Kuncheva")
image(msim)
mean(msim)
max(msim)

k
needs(cluster)
d<-1/msim
hc<-hclust(as.dist(d))
(memb <- cutree(hc, k = 3))

HC <- hclust(as.dist(d), method="single")
plot(2:10, sapply(2:10, function(i) { 
   mean(silhouette(cutree(HC, i), dmatrix=d)[,"sil_width"]) }),
   xlab="Number of clusters", ylab="Average Silhouette", type="b", pch=20)


simils <- tibble(datetime = dates,CCF=NA, CCFvsMean=NA, CCFaveg = NA, CCFsmoothed = NA)
mean.fs <- readRDS(file.path("C:/tmp/32","CCF",20160,3,"2017-10-08_000000.rds"))

fs.prev<-NULL
fs.prev.smoothed<-NULL
fs.smooth <- list()
SMOOTH_SIZE <- 12
thres<-0.01
alpha = 0.4

image(cutoff(mean.fs, thres))
image(cutoff(mlist[[54]], thres))

for(row in 1:nrow(simils)){
  filename <- paste0(format(simils[row,]$datetime,fmt),".rds")
  if (file.exists(file.path(folder, filename))){
    fs <- readRDS(file.path(folder, filename))
    if (!is.null(fs.prev)){
      simils[row,]$CCF<-fsMTS::fsSimilarity(fs.prev, fs,cutoff=T, threshold = thres, method="Kuncheva")
    }
    simils[row,]$CCFvsMean<-fsMTS::fsSimilarity(mean.fs, fs,cutoff=T, threshold = thres, method="Kuncheva")
    
    fs.cut<-fsMTS::cutoff(fs,threshold = thres)
    fs.smooth<-list.prepend(fs.smooth, row=fs.cut)
    if (length(fs.smooth)>SMOOTH_SIZE) fs.smooth<-list.remove(fs.smooth, length(fs.smooth))
    
    smoothed <- matSmoothing(fs.smooth,alpha)
    if (!is.null(fs.prev.smoothed)){
      simils[row,]$CCFsmoothed<-fsMTS::fsSimilarity(fs.prev.smoothed, smoothed,cutoff=T, 
                                                    threshold = thres, method="Kuncheva")
    }
    
    simils[row,]$CCFaveg <- mean(fs, na.rm = T)
    
    fs.prev.smoothed<-smoothed
    fs.prev <- fs
  }
  svMisc::progress(100*row/nrow(simils))
}

mean_roll <- rollify(mean, window = 24)

simils<-simils%>%mutate(CCF.ma=mean_roll(CCF))

simils%>%select(datetime,CCF,CCFsmoothed,CCF.ma,CCFvsMean)%>%gather(key="key", value="value",-one_of("datetime"))%>%
  ggplot(aes(x = datetime, y=value, group=key, col=key))+geom_line()

summary(simils)
simils
```



```{r create_ensemble}
maxlag<-3
fs.distance.global <- readRDS(file.path(dir,"fs",length(series),"distance",20160,maxlag,"2017-10-08_000000.rds"))
fs.CCF.global <- readRDS(file.path(dir,"fs",length(series),"CCF",20160,maxlag,"2017-10-08_000000.rds"))
fs.GLASSO.global <- readRDS(file.path(dir,"fs",length(series),"GLASSOloc",20160,maxlag,0.3,"2017-10-08_000000.rds"))
fs.MI.global <- readRDS(file.path(dir,"fs",length(series),"MI",4032,maxlag,"2017-08-13_000000.rds"))
fs.LARS.global <- readRDS(file.path(dir,"fs",length(series),"LARS",20160,maxlag,"2017-10-08_000000.rds"))
fs.RF.global <- readRDS(file.path(dir,"fs",length(series),"RF",20160,maxlag,"2017-10-08_000000.rds"))

mlist <- list(Distance = fs.distance.global,
              CCF = fs.CCF.global,
              GLASSO = fs.GLASSO.global,
              MI = fs.MI.global,
              LARS = fs.LARS.global,
              RF = fs.RF.global)

th<-0.1
plot(fs.CCF.global, col=rev(heat.colors(10)), key=NULL, main="FS")
plot(cutoff(fs.CCF.global,th), col=rev(heat.colors(10)), key=NULL, main="FS")
plot(cutoff(fs.LARS.global,th), col=rev(heat.colors(10)), key=NULL, main="FS")
mlist[["EnsembleRank"]] <- fsMTS::fsEnsemble(mlist, threshold = th, method="ranking")
mlist[["EnsembleMajV"]] <- fsMTS::fsEnsemble(mlist, threshold = th, method="majority")
(msimilarity <- fsSimilarityMatrix(mlist,threshold = th, method="Hamming"))
colnames(mlist[["EnsembleRank"]])<-colnames(mlist[["EnsembleMajV"]])
rownames(mlist[["EnsembleRank"]])<-rownames(mlist[["EnsembleMajV"]])
  
plot(mlist[["EnsembleMajV"]], col=rev(heat.colors(10)), key=NULL, main="FS")
val<-fsSimilarity(mlist[["EnsembleRank"]],mlist[["EnsembleMajV"]], method="Kuncheva")
fsMTS::fsSparsity(mlist[["EnsembleRank"]])
fsMTS::fsSparsity(mlist[["EnsembleMajV"]])
dir.create(file.path(dir,"fs",length(series),"EnsVoting",20160,maxlag,th), recursive = T)
dir.create(file.path(dir,"fs",length(series),"EnsRanking",20160,maxlag,th), recursive = T)
saveRDS(mlist[["EnsembleMajV"]], file.path(dir,"fs",length(series),"EnsVoting",20160,maxlag,th,"2017-10-08_000000.rds"))
saveRDS(mlist[["EnsembleRank"]], file.path(dir,"fs",length(series),"EnsRanking",20160,maxlag,th,"2017-10-08_000000.rds"))

maxlag<-3
CCFg.folder <- file.path(dir,"fs",length(series),"CCFg",36,maxlag)
MIg.folder <- file.path(dir,"fs",length(series),"MIg",36,maxlag)
GLASSOg.folder <- file.path(dir,"fs",length(series),"GLASSOlocg",36,maxlag,0.3)
LARSg.folder <- file.path(dir,"fs",length(series),"LARSg",36,maxlag)
RFg.folder <- file.path(dir,"fs",length(series),"RFg",36,maxlag)

EnsVotingg.folder <- file.path(dir,"fs",length(series),"EnsVotingg",36,maxlag,th)
dir.create(EnsVotingg.folder, recursive = T)
EnsRankingg.folder <- file.path(dir,"fs",length(series),"EnsRankingg",36,maxlag,th)
dir.create(EnsRankingg.folder, recursive = T)

for (f in list.files(CCFg.folder)){
  fs.CCF.daytime <- readRDS(file.path(CCFg.folder,f))
  fs.GLASSO.daytime <- readRDS(file.path(GLASSOg.folder,f))
  fs.MI.daytime <- readRDS(file.path(MIg.folder,f))
  fs.LARS.daytime <- readRDS(file.path(LARSg.folder,f))
  fs.RF.daytime <- readRDS(file.path(RFg.folder,f))
  mlist <- list(Distance = fs.distance.global,
              CCF = fs.CCF.daytime,
              GLASSO = fs.GLASSO.daytime,
              MI = fs.MI.daytime,
              LARS = fs.LARS.daytime,
              RF = fs.RF.daytime)
  EnsembleRank <- fsMTS::fsEnsemble(mlist, threshold = th, method="ranking")
  EnsembleMajV <- fsMTS::fsEnsemble(mlist, threshold = th, method="majority")
  colnames(EnsembleRank)<-colnames(EnsembleMajV)
  rownames(EnsembleRank)<-rownames(EnsembleMajV)
  saveRDS(EnsembleMajV,file.path(EnsVotingg.folder,f))
  saveRDS(EnsembleRank,file.path(EnsRankingg.folder,f))
  print(paste(f,"Sparsity",fsMTS::fsSparsity(EnsembleMajV)))
}



CCF.folder <- file.path(dir,"fs",length(series),"CCF",36,maxlag)
MI.folder <- file.path(dir,"fs",length(series),"MI",36,maxlag)
GLASSO.folder <- file.path(dir,"fs",length(series),"GLASSOloc",36,maxlag,0.3)
LARS.folder <- file.path(dir,"fs",length(series),"LARS",36,maxlag)
RF.folder <- file.path(dir,"fs",length(series),"RF",36,maxlag)

EnsVoting.folder <- file.path(dir,"fs",length(series),"EnsVoting",36,maxlag,th)
dir.create(EnsVoting.folder, recursive = T)
EnsRanking.folder <- file.path(dir,"fs",length(series),"EnsRanking",36,maxlag,th)
dir.create(EnsRanking.folder, recursive = T)

for (f in list.files(CCF.folder)){
  fs.CCF.dynamic <- readRDS(file.path(CCF.folder,f))
  fs.GLASSO.dynamic <- readRDS(file.path(GLASSO.folder,f))
  fs.MI.dynamic <- readRDS(file.path(MI.folder,f))
  fs.LARS.dynamic <- readRDS(file.path(LARS.folder,f))
  fs.RF.dynamic <- readRDS(file.path(RF.folder,f))
  mlist <- list(Distance = fs.distance.global,
              CCF = fs.CCF.dynamic,
              GLASSO = fs.GLASSO.dynamic,
              MI = fs.MI.dynamic,
              LARS = fs.LARS.dynamic,
              RF = fs.RF.dynamic)
  EnsembleRank <- fsMTS::fsEnsemble(mlist, threshold = th, method="ranking")
  EnsembleMajV <- fsMTS::fsEnsemble(mlist, threshold = th, method="majority")
  colnames(EnsembleRank)<-colnames(EnsembleMajV)
  rownames(EnsembleRank)<-rownames(EnsembleMajV)
  saveRDS(EnsembleMajV,file.path(EnsVoting.folder,f))
  saveRDS(EnsembleRank,file.path(EnsRanking.folder,f))
  print(paste(f,"Sparsity",fsMTS::fsSparsity(EnsembleMajV)))
}

```
