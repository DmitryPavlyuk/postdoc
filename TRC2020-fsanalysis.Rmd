---
title: "Ensemble feature selection"
author: "Dmitry Pavlyuk"
date: "March 24, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This markdown document reproduces the research "Robust learning of urban traffic flows' spatiotemporal structure" (to be submitted)


```{r child='sampling.Rmd'}
```


Load necessary libraries
----------------
```{r libs}
library(needs)
needs(knitr)
needs(tidyverse)
needs(reshape2)
needs(ggplot2)
needs(geosphere)
needs(igraph)
needs(Metrics)
needs(imputeTS)
needs(e1071)
needs(MTS)
needs(forecast)
needs(doParallel)
needs(glasso)
needs(scales)
needs(stringr)
needs(e1071 )
needs(randomForest )
needs(Boruta)

source(file.path("R","prepare_data_functions.R"))
source(file.path("R","cv_functions.R"))
source(file.path("R","cv_utils.R"))
source(file.path("R","models_util.R"))
source(file.path("R","models_baseline.R"))
source(file.path("R","models_spvar.R"))
source(file.path("R","models_spatial.R"))


# Define files for intermediate results
dir<-"TRC2020"
models.estimated.file <- file.path(dir,"models.rds")
results.file <- file.path(dir,"results.rds")
complete.rds <- file.path("data","prepared","ALL5-original.rds")
sample.rds <- file.path(dir,"data64.rds")
ta<-5
```

```{r fs_stability}
require(needs)
needs(ggplot2)
needs(tibbletime)
needs(tidyverse)
needs(svMisc)
needs(rlist)
needs(plot.matrix)
needs(fsMTS)


oneStepSimilarity <- function(folder, date.from,date.to, threshold, method){
  dates <- seq(from=date.from, to=date.to, by="5 min")
  res <- NULL
  fs.prev<-NULL
  for(row in 1:length(dates)){
    name<-format(dates[row],fmt)
    filename <- paste0(name,".rds")
    if (file.exists(file.path(folder, filename))){
      fs <- readRDS(file.path(folder, filename))
      if (!is.null(fs.prev)){
        res <- bind_rows(res,
                         list(datetime=dates[row], 
                         similarity=fsMTS::fsSimilarity(fs.prev, fs,cutoff=T, 
                                                        threshold = threshold, method=method),
                         threshold = threshold,
                         method=method,
                         key=folder))
      }
      fs.prev <- fs
    }else{
      fs.prev <- NULL
    }
  }
  return(res)
}

fs1 <- readRDS("C:/Dmitry/projects/postdoc/TRC2020/fs/64/RF/4032/3/2017-08-13_000000.rds")
fs2 <- readRDS("C:/Dmitry/projects/postdoc/TRC2020/fs/64/RF/20160/3/2017-10-08_000000.rds")
cor(as.vector(fs1),as.vector(fs2))
fsMTS::fsSimilarity(fs1,fs2, cutoff=T, threshold=0.5, method = "Kuncheva")

folder<-file.path("C:/tmp/32","CCF",144,3)
fmt <- "%Y-%m-%d_%H%M%S"
date.from <- as.POSIXct("2017-07-31_000000",format=fmt)
date.to <- as.POSIXct("2017-10-07_000000",format=fmt)

sim.tibble<-NULL
for (th in c(0.99)){
  for (method in c("Jaccard", "Kuncheva")){
    print(paste("Estimating: threshold=",th,", method=", method))
    r<-oneStepSimilarity(folder, date.from,date.to, threshold=th, method=method)
    sim.tibble<- bind_rows(sim.tibble, r)
  }
}

res<-sim.tibble%>%mutate(dow_time=format(datetime,"%w %H:%M"))

res%>%filter(method=="Kuncheva")%>%mutate(key=paste(key, threshold))%>%group_by(key,dow_time)%>%summarise(mean.similarity=mean(similarity))%>%ggplot(aes(x = dow_time, y=mean.similarity, group=key, col=key))+geom_line()

stat<-res%>%group_by(method,key,threshold)%>%summarise(mean.similarity=mean(similarity))
stat%>%ungroup%>%mutate(key=paste(key, method))%>%group_by(key)%>%ggplot(aes(x = threshold, y=mean.similarity, group=key, col=key))+geom_line()
```
```{r}

fs <- readRDS(file.path(folder,"2017-07-31_080000.rds"))
res<-as_tibble(cutoff(fs,0.1),rownames = "lnode")%>%gather(key="node", value="value",-one_of("lnode"))%>%filter(value==1)%>%
  mutate(lag=as.numeric(substr(lnode,regexpr(".l",lnode)+2,length(lnode))),
         related_node=substr(lnode,1,regexpr(".l",lnode)-1))%>%select(node,related_node,lag)
res%>%group_by(node,lag)%>%summarise(n=n())%>%arrange(node,desc(n))%>%print(n=100)

res%>%filter(node=="rnd_95775")%>%print(n=30)
related<-res%>%filter(node=="rnd_95775")%>%select(related_node)%>%pull
write.csv(mysample$config.nodes%>%filter(node_name %in% related)%>%inner_join(res%>%filter(node=="rnd_95775"), by=c("node_name"="related_node")),file.path(dir,"nodes-lag1.csv"),  row.names = F)

```

```{r}
dates <- seq(from=date.from, to=date.to, by="5 min")

mlist<-list()
for(row in 1:length(dates)){
  name<-format(dates[row],fmt)
  filename <- paste0(name,".rds")
  if (file.exists(file.path(folder, filename))){
    fs <- readRDS(file.path(folder, filename))
    mlist[[name]]<-fs
  }
}
msim<-fsSimilarityMatrix(mlist,threshold=0.2,method="Kuncheva")
image(msim)
mean(msim)
max(msim)

k
needs(cluster)
d<-1/msim
hc<-hclust(as.dist(d))
(memb <- cutree(hc, k = 3))

HC <- hclust(as.dist(d), method="single")
plot(2:10, sapply(2:10, function(i) { 
   mean(silhouette(cutree(HC, i), dmatrix=d)[,"sil_width"]) }),
   xlab="Number of clusters", ylab="Average Silhouette", type="b", pch=20)


simils <- tibble(datetime = dates,CCF=NA, CCFvsMean=NA, CCFaveg = NA, CCFsmoothed = NA)
mean.fs <- readRDS(file.path("C:/tmp/32","CCF",20160,3,"2017-10-08_000000.rds"))

fs.prev<-NULL
fs.prev.smoothed<-NULL
fs.smooth <- list()
SMOOTH_SIZE <- 12
thres<-0.01
alpha = 0.4

image(cutoff(mean.fs, thres))
image(cutoff(mlist[[54]], thres))

for(row in 1:nrow(simils)){
  filename <- paste0(format(simils[row,]$datetime,fmt),".rds")
  if (file.exists(file.path(folder, filename))){
    fs <- readRDS(file.path(folder, filename))
    if (!is.null(fs.prev)){
      simils[row,]$CCF<-fsMTS::fsSimilarity(fs.prev, fs,cutoff=T, threshold = thres, method="Kuncheva")
    }
    simils[row,]$CCFvsMean<-fsMTS::fsSimilarity(mean.fs, fs,cutoff=T, threshold = thres, method="Kuncheva")
    
    fs.cut<-fsMTS::cutoff(fs,threshold = thres)
    fs.smooth<-list.prepend(fs.smooth, row=fs.cut)
    if (length(fs.smooth)>SMOOTH_SIZE) fs.smooth<-list.remove(fs.smooth, length(fs.smooth))
    
    smoothed <- matSmoothing(fs.smooth,alpha)
    if (!is.null(fs.prev.smoothed)){
      simils[row,]$CCFsmoothed<-fsMTS::fsSimilarity(fs.prev.smoothed, smoothed,cutoff=T, 
                                                    threshold = thres, method="Kuncheva")
    }
    
    simils[row,]$CCFaveg <- mean(fs, na.rm = T)
    
    fs.prev.smoothed<-smoothed
    fs.prev <- fs
  }
  svMisc::progress(100*row/nrow(simils))
}

mean_roll <- rollify(mean, window = 24)

simils<-simils%>%mutate(CCF.ma=mean_roll(CCF))

simils%>%select(datetime,CCF,CCFsmoothed,CCF.ma,CCFvsMean)%>%gather(key="key", value="value",-one_of("datetime"))%>%
  ggplot(aes(x = datetime, y=value, group=key, col=key))+geom_line()

summary(simils)
simils
```
